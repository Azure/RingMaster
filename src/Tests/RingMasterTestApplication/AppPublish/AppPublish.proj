<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(EnvironmentConfig)" />
  <ItemGroup>
    <ProjectReference Include="..\ConnectionStressService\ConnectionStressService.csproj" />
    <ProjectReference Include="..\ControlPlaneStressService\ControlPlaneStressService.csproj" />
    <ProjectReference Include="..\EnumerationStressService\EnumerationStressService.csproj" />
    <ProjectReference Include="..\PopulationStressService\PopulationStressService.csproj" />
    <ProjectReference Include="..\ServingPlaneStressService\ServingPlaneStressService.csproj" />
    <ProjectReference Include="..\SubscribeStressService\SubscribeStressService.csproj" />
  </ItemGroup>
  <Import Project="$(MSBuildBinPath)\Microsoft.Common.targets" />

  <PropertyGroup>
    <BinariesBuildTypeArchDirectory Condition="'$(BinariesBuildTypeArchDirectory)' == ''">$(OUTPUTROOT)\$(BuildType)-$(BuildArchitecture)</BinariesBuildTypeArchDirectory>
    <PackageLocation>$(BinariesBuildTypeArchDirectory)\RingMasterTestApplication-Pkg</PackageLocation>
    <BuildDependsOn>ResolveReferences</BuildDependsOn>
  </PropertyGroup>

  <Target Name="CopyFiles" AfterTargets="Build">
    <ItemGroup>
      <ConnectionStressBins   Include="$(BinariesBuildTypeArchDirectory)\Microsoft.RingMaster.Test.ConnectionStressService\**\*.*" />
      <ControlPlaneStressBins Include="$(BinariesBuildTypeArchDirectory)\Microsoft.RingMaster.Test.ControlPlaneStressService\**\*.*" />
      <EnumerationStressBins Include="$(BinariesBuildTypeArchDirectory)\Microsoft.RingMaster.Test.EnumerationStressService\**\*.*" />
      <PopulationStressBins Include="$(BinariesBuildTypeArchDirectory)\Microsoft.RingMaster.Test.PopulationStressService\**\*.*" />
      <ServingPlaneStressBins Include="$(BinariesBuildTypeArchDirectory)\Microsoft.RingMaster.Test.ServingPlaneStressService\**\*.*" />
      <SubscribeStressBins  Include="$(BinariesBuildTypeArchDirectory)\Microsoft.RingMaster.Test.SubscribeStressService\**\*.*" />

      <ConnectionStressXmls  Include="..\ConnectionStressService\PackageRoot\**\*.*" />
      <ControlPlaneStressXmls Include="..\ControlPlaneStressService\PackageRoot\**\*.*" />
      <EnumerationStressXmls Include="..\EnumerationStressService\PackageRoot\**\*.*" />
      <PopulationStressXmls Include="..\PopulationStressService\PackageRoot\**\*.*" />
      <ServingPlaneStressXmls Include="..\ServingPlaneStressService\PackageRoot\**\*.*" />
      <SubscribeStressXmls Include="..\SubscribeStressService\PackageRoot\**\*.*" />
    </ItemGroup>

    <Copy SourceFiles="@(ConnectionStressBins)"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication\ConnectionStressService\Code" />
    <Copy SourceFiles="@(ConnectionStressXmls)"
          DestinationFiles="@(ConnectionStressXmls->'$(PackageLocation)\RingMasterTestApplication\ConnectionStressService\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Copy SourceFiles="@(ControlPlaneStressBins)"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication\ControlPlaneStressService\Code" />
    <Copy SourceFiles="@(ControlPlaneStressXmls)"
          DestinationFiles="@(ControlPlanestressXmls->'$(PackageLocation)\RingMasterTestApplication\ControlPlaneStressService\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Copy SourceFiles="@(EnumerationStressBins)"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication\EnumerationStressService\Code" />
    <Copy SourceFiles="@(EnumerationStressXmls)"
          DestinationFiles="@(EnumerationStressXmls->'$(PackageLocation)\RingMasterTestApplication\EnumerationStressService\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Copy SourceFiles="@(PopulationStressBins)"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication\PopulationStressService\Code" />
    <Copy SourceFiles="@(PopulationStressXmls)"
          DestinationFiles="@(PopulationStressXmls->'$(PackageLocation)\RingMasterTestApplication\PopulationStressService\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Copy SourceFiles="@(ServingPlaneStressBins)"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication\ServingPlaneStressService\Code" />
    <Copy SourceFiles="@(ServingPlaneStressXmls)"
          DestinationFiles="@(ServingPlaneStressXmls->'$(PackageLocation)\RingMasterTestApplication\ServingPlaneStressService\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Copy SourceFiles="@(SubscribeStressBins)"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication\SubscribeStressService\Code" />
    <Copy SourceFiles="@(SubscribeStressXmls)"
          DestinationFiles="@(SubscribeStressXmls->'$(PackageLocation)\RingMasterTestApplication\SubscribeStressService\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Copy SourceFiles="..\ApplicationPackageRoot\ApplicationManifest.xml"
          DestinationFolder="$(PackageLocation)\RingMasterTestApplication" />
    <Copy SourceFiles="..\ApplicationParameters\Local.xml"
          DestinationFolder="$(PackageLocation)" />
  </Target>

  <Target Name="VersionPackage" AfterTargets="CopyFiles">
    <ItemGroup>
      <FilesToProcess Include="$(PackageLocation)\**\ApplicationManifest.xml" />
      <FilesToProcess Include="$(PackageLocation)\**\**\ServiceManifest.xml" />
    </ItemGroup>
    <SimpleReplace Path="%(FilesToProcess.Identity)" Find="#BUILDNUMBER#" Replace="$(BuildNumber)" />
  </Target>

  <ItemGroup>
    <QCustomInput Include="..\ConnectionStressService\PackageRoot\Config\Settings.xml" />
    <QCustomInput Include="..\ConnectionStressService\PackageRoot\ServiceManifest.xml" />
    <QCustomInput Include="..\ControlPlaneStressService\PackageRoot\Config\Settings.xml" />
    <QCustomInput Include="..\ControlPlaneStressService\PackageRoot\ServiceManifest.xml" />
    <QCustomInput Include="..\EnumerationStressService\PackageRoot\Config\Settings.xml" />
    <QCustomInput Include="..\EnumerationStressService\PackageRoot\ServiceManifest.xml" />
    <QCustomInput Include="..\PopulationStressService\PackageRoot\Config\Settings.xml" />
    <QCustomInput Include="..\PopulationStressService\PackageRoot\ServiceManifest.xml" />
    <QCustomInput Include="..\ServingPlaneStressService\PackageRoot\Config\Settings.xml" />
    <QCustomInput Include="..\ServingPlaneStressService\PackageRoot\ServiceManifest.xml" />
    <QCustomInput Include="..\SubscribeStressService\PackageRoot\Config\Settings.xml" />
    <QCustomInput Include="..\SubscribeStressService\PackageRoot\ServiceManifest.xml" />
    <QCustomInput Include="..\ApplicationPackageRoot\ApplicationManifest.xml" />
    <QCustomInput Include="..\ApplicationParameters\Local.xml" />
  </ItemGroup>

  <Target Name="VerifyAlteredTargetsUsed" />
  <Target Name="CleanupEmptyRefsFolder" />
</Project>
